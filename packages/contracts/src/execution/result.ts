import type { Diagnostic } from '../core/diagnostic.js';

/**
 * Status of a step execution
 */
export type StepStatus =
  | 'passed' // All checks passed
  | 'failed' // Critical errors found
  | 'warning' // Non-critical issues found
  | 'skipped' // Step was skipped (disabled or condition not met)
  | 'timeout' // Step timed out
  | 'error'; // Internal error during execution

import type { FailurePolicy } from './failure-policy.js';

/**
 * Result of a single filter step execution
 */
export interface StepResult {
  /**
   * Filter ID that produced this result
   */
  filterId: string;

  /**
   * Filter version at execution time
   */
  filterVersion?: string;

  /**
   * Correlation ID for tracing across systems
   */
  correlationId?: string;

  /**
   * Execution status
   */
  status: StepStatus;

  /**
   * Diagnostics generated by this step
   */
  diagnostics: Diagnostic[];

  /**
   * Execution duration in milliseconds
   */
  durationMs: number;

  /**
   * When execution started (ISO 8601)
   */
  startedAt?: string;

  /**
   * When execution completed (ISO 8601)
   */
  completedAt?: string;

  /**
   * Failure policy that was applied
   */
  appliedFailurePolicy?: FailurePolicy;

  /**
   * Number of retry attempts
   */
  retryCount?: number;

  /**
   * Additional metadata from the filter
   */
  metadata?: Record<string, unknown>;

  /**
   * Error details (if status is 'error')
   */
  error?: {
    name: string;
    message: string;
    stack?: string;
  };

  /**
   * Child results (for parallel step groups)
   */
  children?: StepResult[];

  /**
   * Billing event generated by this step
   */
  billingEvent?: BillingEventRef;
}

/**
 * Reference to a billing event
 */
export interface BillingEventRef {
  eventId: string;
  eventType: string;
  billable: boolean;
}

/**
 * Aggregated statistics for step results
 */
export interface StepStatistics {
  /** Total number of steps executed */
  total: number;

  /** Number of passed steps */
  passed: number;

  /** Number of failed steps */
  failed: number;

  /** Number of steps with warnings */
  warnings: number;

  /** Number of skipped steps */
  skipped: number;

  /** Number of timed out steps */
  timedOut: number;

  /** Number of steps with errors */
  errors: number;

  /** Total execution time (ms) */
  totalDurationMs: number;
}
