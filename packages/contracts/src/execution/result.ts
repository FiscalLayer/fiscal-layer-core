import type { Diagnostic } from '../core/diagnostic.js';
import type { FailurePolicy } from './failure-policy.js';

/**
 * Execution status of a step - describes what happened during execution.
 *
 * OSS Boundary: This type describes EXECUTION FACTS, not VALIDATION DECISIONS.
 * - 'ran': The step executed to completion (regardless of what it found)
 * - 'skipped': The step was not executed (disabled, condition not met, or pipeline aborted)
 * - 'errored': The step failed due to internal error (exception, timeout, misconfiguration)
 *
 * Validation decisions (passed/failed/warning) are made by the Private decision layer
 * based on the diagnostics produced by each step.
 */
export type ExecutionStatus = 'ran' | 'skipped' | 'errored';

/**
 * @deprecated Use ExecutionStatus instead.
 * StepStatus will be removed in the next major version.
 *
 * This type conflates execution facts with validation decisions.
 * - 'passed', 'failed', 'warning' are DECISIONS (should be Private)
 * - 'skipped', 'timeout', 'error' are EXECUTION FACTS (OSS)
 *
 * Migration: Use ExecutionStatus + diagnostics for OSS packages.
 * Decision logic (interpreting diagnostics as pass/fail) belongs in Private layer.
 */
export type StepStatus =
  | 'passed' // Decision - use ExecutionStatus + diagnostics instead
  | 'failed' // Decision - use ExecutionStatus + diagnostics instead
  | 'warning' // Decision - use ExecutionStatus + diagnostics instead
  | 'skipped' // Fact - maps to ExecutionStatus 'skipped'
  | 'timeout' // Fact - maps to ExecutionStatus 'errored'
  | 'error'; // Fact - maps to ExecutionStatus 'errored'

/**
 * Result of a single filter step execution.
 *
 * OSS Boundary: StepResult captures EXECUTION FACTS and DIAGNOSTICS.
 * - `execution`: What happened (ran/skipped/errored)
 * - `diagnostics`: Structured findings (codes, evidence, spec references)
 *
 * The Private decision layer interprets diagnostics into decisions
 * (ALLOW/ALLOW_WITH_WARNINGS/BLOCK) based on policy configuration.
 *
 * NOTE: The `status` field has been REMOVED from StepResult.
 * Use `execution` for execution facts and `diagnostics` for findings.
 * For legacy compatibility, use `LegacyStepResult` and `migrateLegacyStepResult()`.
 */
export interface StepResult {
  /**
   * Filter ID that produced this result
   */
  filterId: string;

  /**
   * Filter version at execution time
   */
  filterVersion?: string;

  /**
   * Correlation ID for tracing across systems
   */
  correlationId?: string;

  /**
   * Execution status - describes what happened during execution.
   * Does NOT indicate validation pass/fail - that's determined by
   * the Private decision layer based on diagnostics.
   */
  execution: ExecutionStatus;

  /**
   * Diagnostics generated by this step.
   * These are FACTS (structured findings with codes, evidence, spec references).
   * The Private decision layer interprets these into decisions.
   */
  diagnostics: Diagnostic[];

  /**
   * Execution duration in milliseconds
   */
  durationMs: number;

  /**
   * When execution started (ISO 8601)
   */
  startedAt?: string;

  /**
   * When execution completed (ISO 8601)
   */
  completedAt?: string;

  /**
   * Failure policy that was applied
   */
  appliedFailurePolicy?: FailurePolicy;

  /**
   * Number of retry attempts
   */
  retryCount?: number;

  /**
   * Additional metadata from the filter
   */
  metadata?: Record<string, unknown>;

  /**
   * Error details (if status is 'error')
   */
  error?: {
    name: string;
    message: string;
    stack?: string;
  };

  /**
   * Child results (for parallel step groups)
   */
  children?: StepResult[];

  /**
   * Billing event generated by this step
   */
  billingEvent?: BillingEventRef;
}

/**
 * Reference to a billing event
 */
export interface BillingEventRef {
  eventId: string;
  eventType: string;
  billable: boolean;
}

/**
 * Aggregated statistics for step results.
 *
 * OSS Boundary: Statistics describe EXECUTION FACTS only.
 * - How many steps ran, skipped, errored
 * - Total execution time
 *
 * Decision-based statistics (passed/failed/warnings counts) belong
 * in the Private decision layer.
 */
export interface StepStatistics {
  /** Total number of steps in the pipeline */
  total: number;

  /** Number of steps that executed to completion */
  ran: number;

  /** Number of skipped steps (disabled, condition not met, pipeline aborted) */
  skipped: number;

  /** Number of steps that errored (exception, timeout, misconfiguration) */
  errored: number;

  /** Total execution time (ms) */
  totalDurationMs: number;
}

/**
 * @deprecated Use StepStatistics instead.
 * LegacyStepStatistics will be removed in the next major version.
 *
 * This interface includes decision-based counts (passed/failed/warnings)
 * which violate the OSS boundary.
 */
export interface LegacyStepStatistics {
  /** Total number of steps executed */
  total: number;

  /** @deprecated Decision-based count - use diagnostics for decision logic */
  passed: number;

  /** @deprecated Decision-based count - use diagnostics for decision logic */
  failed: number;

  /** @deprecated Decision-based count - use diagnostics for decision logic */
  warnings: number;

  /** Number of skipped steps */
  skipped: number;

  /** Number of timed out steps */
  timedOut: number;

  /** Number of steps with errors */
  errors: number;

  /** Total execution time (ms) */
  totalDurationMs: number;
}

// =============================================================================
// Legacy Migration Helpers
// =============================================================================

/**
 * @deprecated Legacy StepResult interface with decision-based status.
 * Use StepResult with ExecutionStatus instead.
 *
 * This interface is provided for backwards compatibility during migration.
 * New code should use StepResult with `execution` field.
 */
export interface LegacyStepResult {
  filterId: string;
  filterVersion?: string;
  correlationId?: string;
  /** @deprecated Decision-based status - use execution + diagnostics */
  // eslint-disable-next-line @typescript-eslint/no-deprecated -- Backwards compatibility: StepStatus used in legacy interface
  status: StepStatus;
  diagnostics: Diagnostic[];
  durationMs: number;
  startedAt?: string;
  completedAt?: string;
  appliedFailurePolicy?: FailurePolicy;
  retryCount?: number;
  metadata?: Record<string, unknown>;
  error?: {
    name: string;
    message: string;
    stack?: string;
  };
  // eslint-disable-next-line @typescript-eslint/no-deprecated -- Backwards compatibility: recursive legacy type
  children?: LegacyStepResult[];
  billingEvent?: BillingEventRef;
}

/**
 * Converts a LegacyStepResult to the new StepResult format.
 *
 * Migration mapping:
 * - 'passed' | 'failed' | 'warning' → 'ran' (step completed, decisions from diagnostics)
 * - 'skipped' → 'skipped'
 * - 'timeout' | 'error' → 'errored'
 *
 * The legacy `status` field is preserved for backwards compatibility
 * but marked as deprecated.
 *
 * @param legacy - The legacy step result to migrate
 * @returns The migrated step result with ExecutionStatus
 */
// eslint-disable-next-line @typescript-eslint/no-deprecated -- Migration helper for legacy types
export function migrateLegacyStepResult(legacy: LegacyStepResult): StepResult {
  // eslint-disable-next-line @typescript-eslint/no-deprecated -- Accessing deprecated status for migration
  const executionStatus = mapStatusToExecution(legacy.status);

  // Build result with required fields first
  // NOTE: We intentionally drop `status` - it belongs in LegacyStepResult only
  const result: StepResult = {
    filterId: legacy.filterId,
    execution: executionStatus,
    diagnostics: legacy.diagnostics,
    durationMs: legacy.durationMs,
  };

  // Add optional fields only if defined (exactOptionalPropertyTypes compliance)
  if (legacy.filterVersion !== undefined) {
    result.filterVersion = legacy.filterVersion;
  }
  if (legacy.correlationId !== undefined) {
    result.correlationId = legacy.correlationId;
  }
  if (legacy.startedAt !== undefined) {
    result.startedAt = legacy.startedAt;
  }
  if (legacy.completedAt !== undefined) {
    result.completedAt = legacy.completedAt;
  }
  if (legacy.appliedFailurePolicy !== undefined) {
    result.appliedFailurePolicy = legacy.appliedFailurePolicy;
  }
  if (legacy.retryCount !== undefined) {
    result.retryCount = legacy.retryCount;
  }
  if (legacy.metadata !== undefined) {
    result.metadata = legacy.metadata;
  }
  if (legacy.error !== undefined) {
    result.error = legacy.error;
  }
  if (legacy.children !== undefined) {
    result.children = legacy.children.map(migrateLegacyStepResult);
  }
  if (legacy.billingEvent !== undefined) {
    result.billingEvent = legacy.billingEvent;
  }

  return result;
}

/**
 * Maps legacy StepStatus to ExecutionStatus.
 *
 * @internal
 */
// eslint-disable-next-line @typescript-eslint/no-deprecated -- Migration helper for legacy StepStatus
function mapStatusToExecution(status: StepStatus): ExecutionStatus {
  switch (status) {
    case 'passed':
    case 'failed':
    case 'warning':
      // Decision statuses → step actually ran
      return 'ran';
    case 'skipped':
      return 'skipped';
    case 'timeout':
    case 'error':
      return 'errored';
    default: {
      // Exhaustive check
      const _exhaustive: never = status;
      return _exhaustive;
    }
  }
}

/**
 * Migrates LegacyStepStatistics to StepStatistics.
 *
 * Decision-based counts (passed/failed/warnings) are dropped.
 * The Private decision layer should compute these from diagnostics.
 *
 * @param legacy - The legacy statistics to migrate
 * @returns The migrated statistics with execution-based counts
 */
// eslint-disable-next-line @typescript-eslint/no-deprecated -- Migration helper for legacy statistics
export function migrateLegacyStepStatistics(legacy: LegacyStepStatistics): StepStatistics {
  return {
    total: legacy.total,
    // ran = passed + failed + warnings (all steps that completed)
    // eslint-disable-next-line @typescript-eslint/no-deprecated -- Accessing deprecated fields for migration
    ran: legacy.passed + legacy.failed + legacy.warnings,
    skipped: legacy.skipped,
    // errored = timedOut + errors
    errored: legacy.timedOut + legacy.errors,
    totalDurationMs: legacy.totalDurationMs,
  };
}

// =============================================================================
// Status Derivation - REMOVED FROM OSS
// =============================================================================
//
// deriveStepStatus() has been REMOVED from OSS exports.
//
// Reason: It reads `diagnostics.some(d => d.severity === 'error')` which is
// DECISION LOGIC. The OSS layer should report execution facts only.
//
// Migration for Private layer / tests:
// Copy this implementation to your private decision-engine package or test utilities:
//
// ```typescript
// function deriveStepStatus(result: StepResult): StepStatus {
//   switch (result.execution) {
//     case 'skipped': return 'skipped';
//     case 'errored':
//       if (result.error?.name?.toLowerCase().includes('timeout')) return 'timeout';
//       return 'error';
//     case 'ran': {
//       const hasErrors = result.diagnostics.some((d) => d.severity === 'error');
//       const hasWarnings = result.diagnostics.some((d) => d.severity === 'warning');
//       if (hasErrors) return 'failed';
//       if (hasWarnings) return 'warning';
//       return 'passed';
//     }
//   }
// }
// ```
//
// For tests: Check `execution` + `diagnostics` directly instead of derived status.
